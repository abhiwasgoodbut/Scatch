<%- include('./partials/header') %>

<% if(user.cart == 0){ %>
    <div class="w-full h-screen flex items-start px-20 py-20 gap-10"><h3 class="text-2xl">cart is empty</h3></div>
    
<%}else{ %>
    <div class="w-full h-screen flex items-start px-20 py-20 gap-10">
  <!-- Cart Items -->
  <div class="w-[70%] flex flex-wrap gap-6">
    <% user.cart.forEach(function(cart){ %>
      <div class="w-[30%] rounded-md overflow-hidden shadow">
        <div class="w-full flex justify-center items-center h-80 bg-[<%= cart.bgcolor %>]">
          <img
            class="h-[16rem]"
            src="data:image/jpeg;base64,<%= cart.image.toString('base64') %>"
            alt="<%= cart.name %>"
          />
        </div>
        <div class="w-full flex justify-between px-5 py-4 bg-[<%= cart.panelcolor %>]">
          <h3 class="text-2xl"><%= cart.name %></h3>
          <div class="flex items-center gap-2">
            <i class="w-7 h-7 bg-white flex rounded-full items-center justify-center ri-add-line"></i>
            <div class="px-2 py-1 rounded-md bg-white text-[<%= cart.textcolor %>]">01</div>
            <i class="w-7 h-7 bg-white flex rounded-full items-center justify-center ri-subtract-line"></i>
          </div>
        </div>
        <div class="flex items-center justify-between px-5 py-3">
          <h4 class="text-lg">Net Total</h4>
          <h2 class="text-lg">₹<%= cart.price + 20 - cart.discount %></h2>
        </div>

        <!-- Remove button inside card -->
        <form action="/cart/remove/<%= cart._id %>" method="POST" class="px-5 pb-3">
          <button
            type="submit"
            class="w-full bg-red-500 text-white py-2 rounded-md hover:bg-red-600"
          >
            Remove
          </button>
        </form>
      </div>
    <% }) %>
  </div>
<%}%>



  <!-- Price Breakdown -->
  <div class="w-[30%] bg-white p-6 rounded shadow">
    <h3 class="text-xl mb-4">Price Breakdown</h3>
    <%
      let totalMrp = 0;
      let totalDiscount = 0;
      user.cart.forEach(item => {
        totalMrp += Number(item.price || 0);
        totalDiscount += Number(item.discount || 0);
      });
      let platformFee = 20;
      let shippingFee = 0;
      let totalAmount = totalMrp + platformFee - totalDiscount;
    %>
    <div class="space-y-2">
      <div class="flex justify-between">
        <h4>Total MRP</h4>
        <h4>₹ <%= totalMrp %></h4>
      </div>
      <div class="flex justify-between">
        <h4>Discount on MRP</h4>
        <h4>₹ <%= totalDiscount %></h4>
      </div>
      <div class="flex justify-between">
        <h4>Platform Fee</h4>
        <h4>₹ <%= platformFee %></h4>
      </div>
      <div class="flex justify-between">
        <h4>Shipping Fee</h4>
        <h4><%= shippingFee === 0 ? "FREE" : "₹" + shippingFee %></h4>
      </div>
    </div>

    <div class="w-full h-[1px] bg-black mt-6 mb-4"></div>
    <div class="flex justify-between">
      <h3 class="text-xl">Total Amount</h3>
      <h3 class="font-semibold text-xl text-green-600">₹ <%= totalAmount %></h3>
    </div>

    <!-- Pay button -->
    <button
      id="rzp-button"
      class="mt-6 w-full bg-green-600 text-white py-2 rounded-md"
      data-amount="<%= totalAmount %>"
    >
      Pay with Razorpay
    </button>
  </div>
</div>

<!-- Razorpay Checkout Script -->
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>
  (function () {
    const btn = document.getElementById("rzp-button");
    if (!btn) return;

    btn.addEventListener("click", async function (e) {
      e.preventDefault();
      const amount = Number(btn.dataset.amount || 0);

      try {
        const orderRes = await fetch("/payment/create-order", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ amount })
        });
        const order = await orderRes.json();

        const options = {
          key: "<%= razorpayKeyId %>",
          amount: order.amount,
          currency: order.currency,
          name: "My Shop",
          description: "Cart Checkout",
          order_id: order.id,
          handler: function (response) {
            alert("Payment successful!");
          },
          prefill: {
            name: "<%= (user && user.fullname) || '' %>",
            email: "<%= (user && user.email) || '' %>",
            contact: "<%= (user && user.phone) || '' %>"
          },
          theme: { color: "#3399cc" }
        };

        const rzp = new Razorpay(options);
        rzp.open();
      } catch (err) {
        console.error(err);
        alert("Something went wrong.");
      }
    });
  })();
</script>

<%- include('./partials/footer') %>
